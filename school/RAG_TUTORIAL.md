# RAG 记忆检索系统 使用教程

本教程将手把手教你配置 RAG（检索增强生成）记忆系统。配置完成后，AI 将能够从历史对话中智能检索相关记忆，大幅提升长期对话的连贯性。

---

## 目录

- [什么是 RAG 记忆系统？](#什么是-rag-记忆系统)
- [准备工作：注册 SiliconFlow 并获取 API Key](#准备工作注册-siliconflow-并获取-api-key)
- [在游戏中配置 RAG](#在游戏中配置-rag)
- [验证配置是否生效](#验证配置是否生效)
- [参数调优指南](#参数调优指南)
- [常见问题](#常见问题)

---

## 什么是 RAG 记忆系统？

在长期对话中，AI 的上下文窗口有限，无法记住所有历史内容。RAG 系统通过以下方式解决这个问题：

1. **小总结生成**：每隔几轮对话，系统自动生成一段剧情小总结
2. **向量化（Embedding）**：将每段小总结转换为数学向量，便于语义搜索
3. **语义检索**：当你发送新消息时，系统从所有历史总结中找出与当前话题最相关的内容
4. **重排序（Rerank）**：对检索结果进行精确排序，选出最相关的几条注入 AI 上下文

简单来说：**AI 能"回忆"起与当前话题相关的历史剧情，即使那些内容发生在很久以前。**

### RAG 上下文结构

配置完成后，AI 收到的上下文分为三层：

```
[第一层] RAG 召回的历史总结（语义最相关的远期记忆）
[第二层] 桥接总结（正文边界外最近 5 轮的小总结，保持连贯性）
[第三层] 完整原文（最近 N 轮的完整对话，N 由"正文替换边界"设置决定）
```

---

## 准备工作：注册 SiliconFlow 并获取 API Key

RAG 系统需要两个 API 服务：**Embedding（向量化）** 和 **Rerank（重排序）**。推荐使用 [SiliconFlow（硅基流动）](https://siliconflow.cn)，因为它提供免费的 Embedding 和 Rerank 模型，且兼容 OpenAI API 格式。

### 第一步：注册账号

1. 打开 [https://cloud.siliconflow.cn](https://cloud.siliconflow.cn)
2. 点击右上角「注册」
3. 可以使用手机号、微信或 GitHub 注册
4. 完成注册并登录

### 第二步：获取 API Key

1. 登录后，点击左侧菜单栏的「API 密钥」
2. 点击「创建新的 API 密钥」
3. 给密钥起个名字（比如"RAG记忆系统"），点击确认
4. **复制生成的密钥**（格式类似 `sk-xxxxxxxxxxxxxxxx`）
5. **妥善保存！密钥只显示一次，关闭后无法再查看**

> 💡 SiliconFlow 新用户通常会赠送一定额度的免费 Token，Embedding 和 Rerank 的免费模型不消耗付费额度。

### 第三步：确认可用模型

SiliconFlow 提供多个 Embedding 和 Rerank 模型。推荐使用以下免费模型：

**Embedding 模型（向量化）：**

| 模型 ID | 说明 |
|---------|------|
| `BAAI/bge-m3` | 多语言向量模型，推荐，支持中英文 |
| `BAAI/bge-large-zh-v1.5` | 中文向量模型，中文场景效果好 |

**Rerank 模型（重排序）：**

| 模型 ID | 说明 |
|---------|------|
| `BAAI/bge-reranker-v2-m3` | 多语言重排序模型，推荐 |
| `BAAI/bge-reranker-large` | 通用重排序模型 |

> 以上模型信息可能随 SiliconFlow 平台更新而变化。你可以在配置界面点击「拉取」按钮获取最新的可用模型列表。

---

## 在游戏中配置 RAG

RAG 设置位于手机系统的「设置」面板中（也可以在独立的设置页面找到）。

### 第一步：启用 RAG 系统

1. 打开手机 → 进入「设置」
2. 找到「RAG 记忆检索」区域
3. 打开「启用 RAG 记忆检索」开关

### 第二步：配置 Embedding（向量化）API

| 字段 | 填写内容 |
|------|---------|
| API 地址 | `https://api.siliconflow.cn/v1` |
| API 密钥 | 你在 SiliconFlow 获取的 API Key（`sk-xxx...`） |
| 模型 | 点击「拉取」按钮自动获取模型列表，选择 `BAAI/bge-m3`；或直接手动输入模型 ID |

### 第三步：配置 Rerank（重排序）API

| 字段 | 填写内容 |
|------|---------|
| API 地址 | `https://api.siliconflow.cn/v1` |
| API 密钥 | 同上，填写相同的 API Key |
| 模型 | 点击「拉取」按钮获取列表，选择 `BAAI/bge-reranker-v2-m3`；或手动输入 |

> 💡 Embedding 和 Rerank 使用同一个 SiliconFlow 账号的 API Key 和相同的 API 地址，只是模型不同。

### 第四步：确认小总结系统已开启

RAG 系统依赖小总结数据。请确保：

1. 在设置中「总结系统」已启用
2. 「辅助 AI」已配置（辅助 AI 负责生成小总结）
3. 已经有一些对话历史并生成了小总结

如果你是新开始的对话，需要先聊几轮让系统生成小总结，RAG 才有数据可以检索。

### 第五步：为已有总结生成向量

如果你之前已经有了很多小总结但还没有向量数据：

1. 打开手机 → 进入「向量记忆」面板
2. 系统会提示你可以批量生成向量
3. 点击批量生成，等待处理完成
4. 处理过程中会显示进度（每条总结间隔 200ms，避免 API 过载）

之后新生成的小总结会自动进行向量化，无需手动操作。

---

## 验证配置是否生效

配置完成后，你可以通过以下方式确认 RAG 正在工作：

1. **发送消息时的状态提示**：发送消息后，输入框会短暂显示「正在检索记忆...」，说明 RAG 检索正在进行
2. **查看记忆图谱**：打开手机 → 「向量记忆」面板，可以看到关键词图谱，节点越大表示出现频率越高
3. **对话效果**：尝试提及很久以前的剧情细节，AI 应该能回忆起相关内容

如果某个环节出现问题（比如 API 调用失败），聊天界面底部会显示错误提示条，告诉你具体是哪个环节失败，你可以点击关闭或检查配置。

---

## 参数调优指南

在手机设置的 RAG 区域，有几个高级参数可以调整：

### topK（向量召回数量）

- **默认值**：50
- **范围**：10 - 100
- **作用**：第一阶段从所有向量化总结中召回最相似的 topK 条
- **建议**：
  - 总结数量少于 100 条时，保持默认 50 即可
  - 总结数量超过 500 条时，可以适当提高到 70-80
  - 值越大，召回越全面，但 Rerank 阶段耗时也会增加

### rerankTopN（重排序保留数量）

- **默认值**：15
- **范围**：5 - 30
- **作用**：第二阶段对 topK 条候选结果精排后，保留最相关的 topN 条注入上下文
- **建议**：
  - 15 是一个平衡值，适合大多数场景
  - 如果你的对话涉及很多角色和支线，可以提高到 20-25
  - 如果你希望节省 Token（减少上下文长度），可以降低到 8-10

### 使用上下文增强检索

- **默认**：开启
- **作用**：检索时不仅使用你当前的输入，还会拼接最近 2 条小总结作为查询上下文，提升检索准确度
- **建议**：保持开启。关闭后检索只依赖你当前输入的文字，可能遗漏相关记忆

### Query 改写（自动启用）

如果你配置了辅助 AI，系统会自动使用辅助 AI 对检索查询进行改写：
- 将「前天」「上周」等相对时间转换为具体日期
- 将「他」「她」「那个人」等代词替换为具体角色名
- 这能显著提升检索精度，无需额外配置

---

## 常见问题

### Q: 配置完成后没有效果？

检查以下几点：
1. RAG 开关是否已打开
2. Embedding 和 Rerank 的 API 地址、密钥、模型是否都已填写
3. 是否已有小总结数据（至少需要几条小总结才能检索）
4. 小总结是否已经向量化（查看向量记忆面板是否有数据）

### Q: 提示 API 错误怎么办？

- **401 错误**：API Key 不正确或已过期，请重新生成
- **404 错误**：API 地址不正确，确认填写的是 `https://api.siliconflow.cn/v1`
- **429 错误**：请求过于频繁，稍等片刻再试
- **模型不存在**：确认模型 ID 拼写正确，或点击「拉取」按钮从列表中选择

### Q: 免费额度够用吗？

Embedding 和 Rerank 的免费模型（BAAI/bge 系列）甚至 Qwen 的高级付费模型消耗的额度都非常少（0.3元每百万tokens以下）：
- 每条小总结的向量化大约消耗几百个 Token
- 每次检索的 Rerank 调用也很轻量
- 正常使用下，免费额度足够长期使用

### Q: 可以使用其他 API 服务商吗？

可以。RAG 系统兼容所有 OpenAI 格式的 API，只要服务商提供：
- `/v1/embeddings` 接口（用于向量化）
- `/v1/rerank` 接口（用于重排序）

### Q: 向量数据存储在哪里？

向量数据存储在本地浏览器的存储中（与游戏存档一起）。不会上传到任何服务器。导出存档时会包含向量数据，导入后无需重新生成。

### Q: 总结很多时会不会很慢？

系统做了多项优化：
- 批量向量化时每条间隔 200ms，避免 API 过载
- 检索时使用本地余弦相似度计算，不需要额外 API 调用
- 只有 Rerank 阶段需要一次 API 调用
- 正常情况下整个 RAG 流程在 1-3 秒内完成
